name: iOS starter workflow

on:
  push:
    branches: [ "feature/workflows" ]

jobs:
  deploy_ios:
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v3
        with:
            fetch-depth: 0

      - name: Set env
        id: last_tag
        run: echo "LAST_TAG=$(git tag --sort=committerdate | tail -1)" >> $GITHUB_OUTPUT
      - uses: actions-ecosystem/action-bump-semver@v1
        id: bump-semver
        with:
          current_version: ${{ steps.last_tag.outputs.LAST_TAG }}
          # A semver update level {major, premajor, minor, preminor, patch, prepatch, prerelease}.
          level: patch
      - run: |
          git config user.name abkhare
          git config user.email abhiraj.khare100@gmail.com
          git tag ${{ steps.bump-semver.outputs.new_version }}
          git push --tags
      - name: "Set output"
        id: set-output
        run: |
          echo "multiplat_mobile_version_name=${{ steps.bump-semver.outputs.new_version }}" >> $GITHUB_OUTPUT

          IFS='.' read -r major minor patch <<< "${{ steps.bump-semver.outputs.new_version }}"
          multiplat_mobile_version_code=$((major * 10000 + minor * 100 + patch))

          echo "multiplat_mobile_version_code=${multiplat_mobile_version_code}" >> $GITHUB_OUTPUT
      - name: "Print output"
        run: |
          echo -e "Version name is: \n ${{ steps.set-output.outputs.multiplat_mobile_version_name }}"
          echo -e "Version code is: \n ${{ steps.set-output.outputs.multiplat_mobile_version_code }}"

      - uses: actions/setup-java@v3
        with:
         distribution: 'zulu'
         java-version: '17'
      - name: "Setup Gradle"
        uses: gradle/gradle-build-action@v2
      - name: "Build xcworkspace"
        run: ./gradlew podInstall
      - name: "Setup app version"
        uses: yanamura/ios-bump-version@v1
        with:
          version: ${{ steps.set-output.outputs.multiplat_mobile_version_name }}
          build-number: ${{ steps.set-output.outputs.multiplat_mobile_version_code }}
          project-path: iosApp
